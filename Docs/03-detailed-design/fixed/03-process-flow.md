# 処理フロー

## 5.1 主要処理フロー

### 処理名: リンク切れ調査開始フロー

```
[ユーザーがURLを入力]
        ↓
[調査開始ボタンをクリック]
        ↓
[IPC: startScan 呼び出し]
        ↓
[ScanController.startScan()]
        ↓
[URLバリデーション]
        ├─ エラー → [エラーメッセージ表示] → 終了
        └─ 成功 → 続行
        ↓
[調査履歴レコード作成]
        ↓
[URLキューに開始URLを追加]
        ↓
[visitedUrlsセットを初期化]
        ↓
[並列処理開始]
        ↓
[URLキューからURLを取得]
        ├─ キューが空 → [調査完了処理] → 終了
        └─ URLあり → 続行
        ↓
[URLが調査済みかチェック]
        ├─ 調査済み → [次のURLへ]
        └─ 未調査 → 続行
        ↓
[visitedUrlsに追加]
        ↓
[並列リクエスト数チェック]
        ├─ 上限到達 → [待機]
        └─ 余裕あり → 続行
        ↓
[processUrl() を並列実行]
        ↓
[HTML取得]
        ├─ エラー → [エラー結果を保存] → [次のURLへ]
        └─ 成功 → 続行
        ↓
[HTMLからリンクを抽出]
        ↓
[抽出したリンクをフィルタリング]
        ├─ 調査対象外 → スキップ
        └─ 調査対象 → 続行
        ↓
[リンクをキューに追加]
        ↓
[各リンクをチェック]
        ├─ リンク切れ → [結果を保存]
        └─ 正常 → [次のURLへ]
        ↓
[進捗を更新・通知]
        ↓
[次のURLへ（ループ）]
```

### 処理名: 単一URL処理フロー（processUrl）

```
[processUrl(url) 開始]
        ↓
[LinkChecker.checkLink() 呼び出し]
        ↓
[HttpClient.get() でHTTPリクエスト]
        ├─ タイムアウト → [タイムアウトエラー]
        ├─ ネットワークエラー → [ネットワークエラー]
        ├─ HTTPエラー（404, 500など） → [HTTPエラー]
        └─ 成功（200） → 続行
        ↓
[HTTPステータスコードを確認]
        ├─ 200-299 → [正常]
        ├─ 300-399 → [リダイレクト] → [リダイレクト先をキューに追加]
        └─ 400-599 → [リンク切れ]
        ↓
[HTMLを取得（200の場合）]
        ↓
[LinkChecker.extractLinks() でリンク抽出]
        ↓
[抽出したリンクをフィルタリング]
        ↓
[フィルタリング後のリンクをキューに追加]
        ↓
[結果をLinkCheckResultModelに保存]
        ↓
[進捗を更新]
        ↓
[完了]
```

### 処理名: 調査結果取得フロー

```
[ユーザーが調査結果一覧画面を表示]
        ↓
[IPC: getScanResults 呼び出し]
        ↓
[LinkCheckResultModel.findByScanHistoryId() 呼び出し]
        ↓
[データベースから結果を取得]
        ↓
[フィルタリング・ソート処理]
        ↓
[ページネーション処理]
        ↓
[結果をレンダラープロセスに返却]
        ↓
[UIに結果を表示]
```

## 5.2 処理詳細

### 処理名: リンク切れ調査開始の詳細

- **開始条件**: 
  - ユーザーがURLを入力し、調査開始ボタンをクリック
  - 現在調査が実行されていない
- **処理ステップ**:
  1. URLのバリデーション（形式チェック、アクセス可能性チェック）
  2. 調査履歴レコードを作成（status: 'running'）
  3. 開始URLをキューに追加
  4. visitedUrlsセットを初期化
  5. 並列処理を開始（最大並列リクエスト数まで）
  6. キューからURLを取得
  7. URLが調査済みかチェック（visitedUrlsに存在するか）
  8. 調査済みでない場合、visitedUrlsに追加
  9. processUrl()を並列実行
  10. 進捗を更新・通知（IPC経由）
  11. キューが空になるまで6-10を繰り返し
  12. 調査完了処理（status: 'completed'に更新）
- **終了条件**: 
  - キューが空になった
  - 最大ページ数に到達した
  - 最大階層レベルに到達した
  - ユーザーが停止した
- **エラー時の処理**: 
  - エラーメッセージをログに記録
  - 調査履歴のstatusを'error'に更新
  - ユーザーにエラーメッセージを表示

### 処理名: 単一URL処理（processUrl）の詳細

- **開始条件**: 
  - キューからURLが取得された
  - 並列リクエスト数に余裕がある
- **処理ステップ**:
  1. LinkChecker.checkLink()を呼び出し
  2. HttpClient.get()でHTTPリクエストを送信
  3. レスポンスを確認
  4. HTTPステータスコードを判定
  5. 200-299の場合、HTMLを取得
  6. HTMLからリンクを抽出（LinkChecker.extractLinks()）
  7. 抽出したリンクをフィルタリング（設定に基づく）
  8. フィルタリング後のリンクをキューに追加
  9. リンク切れの場合は結果を保存
  10. 進捗を更新
- **終了条件**: 
  - HTTPリクエストが完了した（成功・失敗問わず）
  - タイムアウトが発生した
- **エラー時の処理**: 
  - エラー情報をLinkCheckResultに保存
  - エラーログを記録
  - 処理を継続（他のURLの調査は続行）

### 処理名: 調査一時停止の詳細

- **開始条件**: 
  - ユーザーが一時停止ボタンをクリック
  - 調査が実行中（status: 'running'）
- **処理ステップ**:
  1. 調査履歴のstatusを'paused'に更新
  2. 現在実行中のリクエストは完了まで待機
  3. 新しいリクエストの開始を停止
  4. 現在の状態を保存
- **終了条件**: 
  - statusが'paused'に更新された
  - 実行中のリクエストが完了した
- **エラー時の処理**: 
  - エラーメッセージを表示
  - 状態をロールバック

### 処理名: 調査再開の詳細

- **開始条件**: 
  - ユーザーが再開ボタンをクリック
  - 調査が一時停止中（status: 'paused'）
- **処理ステップ**:
  1. 調査履歴のstatusを'running'に更新
  2. 並列処理を再開
  3. キューからURLを取得して処理を継続
- **終了条件**: 
  - statusが'running'に更新された
  - 処理が再開された
- **エラー時の処理**: 
  - エラーメッセージを表示
  - 状態をロールバック

## 5.3 例外処理フロー

### 例外1: ネットワークエラー

- **発生条件**: 
  - HTTPリクエストがタイムアウトした
  - 接続が拒否された
  - DNS解決に失敗した
- **処理内容**: 
  1. エラー情報を記録
  2. LinkCheckResultにエラー情報を保存（httpStatusCode: null, errorMessage: "Network error"）
  3. リトライ設定がある場合、リトライを実行
  4. リトライ後も失敗した場合、エラー結果として保存
  5. 処理を継続（他のURLの調査は続行）
- **エラーメッセージ**: "ネットワークエラーが発生しました: {エラー詳細}"

### 例外2: HTTPエラー（404, 500など）

- **発生条件**: 
  - HTTPステータスコードが400-599の範囲
  - 特に404（Not Found）、500（Internal Server Error）
- **処理内容**: 
  1. HTTPステータスコードを記録
  2. LinkCheckResultにリンク切れ情報を保存
  3. brokenLinksCountをインクリメント
  4. 処理を継続（他のURLの調査は続行）
- **エラーメッセージ**: "リンク切れを検出: {URL} (HTTP {ステータスコード})"

### 例外3: データベースエラー

- **発生条件**: 
  - SQLiteへの接続エラー
  - クエリ実行エラー
  - トランザクションエラー
- **処理内容**: 
  1. エラーログを記録
  2. 調査履歴のstatusを'error'に更新
  3. ユーザーにエラーメッセージを表示
  4. 調査を停止
- **エラーメッセージ**: "データベースエラーが発生しました: {エラー詳細}"

### 例外4: 無効なURL

- **発生条件**: 
  - URL形式が不正
  - プロトコルがhttp/httpsでない
  - URLの構文エラー
- **処理内容**: 
  1. URLバリデーションでエラーを検出
  2. エラーメッセージを表示
  3. 調査を開始しない
- **エラーメッセージ**: "無効なURLです: {URL}"

### 例外5: 最大ページ数到達

- **発生条件**: 
  - 調査したページ数が設定した最大ページ数に到達
- **処理内容**: 
  1. 新しいURLの処理を停止
  2. 実行中のリクエストは完了まで待機
  3. 調査履歴のstatusを'completed'に更新
  4. ユーザーに通知
- **エラーメッセージ**: "最大ページ数（{maxPages}）に到達したため、調査を終了しました"

### 例外6: 最大階層レベル到達

- **発生条件**: 
  - 調査した階層レベルが設定した最大階層レベルに到達
- **処理内容**: 
  1. 現在の階層より深いURLの処理を停止
  2. 実行中のリクエストは完了まで待機
  3. 調査履歴のstatusを'completed'に更新
  4. ユーザーに通知
- **エラーメッセージ**: "最大階層レベル（{maxDepth}）に到達したため、調査を終了しました"

## 5.4 バリデーションフロー

### バリデーション1: URL形式チェック

- **対象項目**: 入力URL
- **チェック内容**: 
  1. URL形式が正しいか（正規表現でチェック）
  2. プロトコルがhttpまたはhttpsか
  3. ドメイン部分が存在するか
  4. URLの長さが制限内か（例: 2048文字以内）
- **エラーメッセージ**: 
  - "URL形式が正しくありません"
  - "httpまたはhttpsのURLを入力してください"
  - "URLが長すぎます（最大2048文字）"

### バリデーション2: 調査設定バリデーション

- **対象項目**: 調査設定（最大ページ数、タイムアウトなど）
- **チェック内容**: 
  1. 最大ページ数が1以上、10000以下か
  2. 最大階層レベルが1以上、10以下か
  3. タイムアウト時間が1000ms以上、60000ms以下か
  4. 並列リクエスト数が1以上、20以下か
  5. リトライ回数が0以上、10以下か
- **エラーメッセージ**: 
  - "最大ページ数は1以上10000以下で入力してください"
  - "最大階層レベルは1以上10以下で入力してください"
  - "タイムアウト時間は1000ms以上60000ms以下で入力してください"
  - "並列リクエスト数は1以上20以下で入力してください"
  - "リトライ回数は0以上10以下で入力してください"

### バリデーション3: ドメイン制限チェック

- **対象項目**: 抽出されたリンクURL
- **チェック内容**: 
  1. 設定で「同一ドメインのみ」が選択されている場合
  2. リンクURLのドメインが開始URLのドメインと一致するか
  3. 一致しない場合は調査対象外としてスキップ
- **エラーメッセージ**: なし（エラーではなく、スキップするだけ）

### バリデーション4: ファイルタイプチェック

- **対象項目**: 抽出されたリンクURL
- **チェック内容**: 
  1. 設定で指定されたファイルタイプのみを調査対象とする
  2. URLの拡張子を確認
  3. 拡張子が指定されたファイルタイプに含まれているか
  4. 含まれていない場合は調査対象外としてスキップ
- **エラーメッセージ**: なし（エラーではなく、スキップするだけ）

### バリデーション5: 階層レベルチェック

- **対象項目**: 抽出されたリンクURL
- **チェック内容**: 
  1. 開始URLからの階層レベルを計算
  2. 階層レベルが設定した最大階層レベルを超えていないか
  3. 超えている場合は調査対象外としてスキップ
- **エラーメッセージ**: なし（エラーではなく、スキップするだけ）

## 5.5 並列処理フロー

### 並列処理の制御

```
[並列処理開始]
        ↓
[現在の並列実行数を確認]
        ├─ 上限到達 → [待機キューに追加]
        └─ 余裕あり → 続行
        ↓
[processUrl() を非同期実行]
        ↓
[並列実行数をインクリメント]
        ↓
[processUrl() 完了]
        ↓
[並列実行数をデクリメント]
        ↓
[待機キューから次のURLを取得]
        ↓
[次のURLを処理（ループ）]
```

### 並列処理の同期制御

- **セマフォパターン**: 並列リクエスト数を制限
- **キュー管理**: URLキューで処理順序を管理
- **visitedUrls管理**: Setを使用して重複チェック（スレッドセーフな実装が必要）
- **進捗更新**: アトミック操作で進捗を更新

