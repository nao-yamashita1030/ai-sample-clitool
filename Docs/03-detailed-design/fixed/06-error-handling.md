# エラーハンドリング詳細

## 8.1 エラーコード定義

### エラーコード体系

エラーコードは以下の形式で定義：
- **形式**: `{カテゴリ}_{番号}`
- **カテゴリ**: 
  - `VALIDATION`: バリデーションエラー
  - `NETWORK`: ネットワークエラー
  - `DATABASE`: データベースエラー
  - `FILE`: ファイル操作エラー
  - `SYSTEM`: システムエラー

### エラーコード一覧

| エラーコード | エラーメッセージ | 説明 | 対処方法 |
|------------|----------------|------|---------|
| VALIDATION_001 | "無効なURLです" | URL形式が不正 | 正しいURL形式で入力 |
| VALIDATION_002 | "最大ページ数は1以上10000以下で入力してください" | 設定値が範囲外 | 設定値を修正 |
| NETWORK_001 | "ネットワークエラーが発生しました" | HTTPリクエスト失敗 | ネットワーク接続を確認 |
| NETWORK_002 | "タイムアウトが発生しました" | リクエストがタイムアウト | タイムアウト時間を延長 |
| DATABASE_001 | "データベースエラーが発生しました" | データベース接続エラー | データベースファイルを確認 |
| DATABASE_002 | "調査履歴が見つかりません" | 指定した調査履歴が存在しない | 正しい調査履歴IDを指定 |
| FILE_001 | "ファイルの保存に失敗しました" | ファイル保存エラー | ファイルパスと権限を確認 |
| SYSTEM_001 | "予期しないエラーが発生しました" | システムエラー | アプリケーションを再起動 |

## 8.2 エラー処理詳細

### エラー1: URLバリデーションエラー

- **発生条件**: URL形式が不正、プロトコルがhttp/httpsでない、ドメインが存在しない
- **エラーコード**: `VALIDATION_001`
- **処理内容**: 
  1. エラーメッセージを表示
  2. 調査開始ボタンを無効化
  3. エラーログを記録
- **ユーザーへの通知**: URL入力フィールドの下にエラーメッセージを表示
- **ログ出力**: `[ERROR] Validation error: Invalid URL - {url}`

### エラー2: ネットワークエラー

- **発生条件**: HTTPリクエストが失敗、タイムアウト、接続拒否
- **エラーコード**: `NETWORK_001`, `NETWORK_002`
- **処理内容**: 
  1. エラー情報をLinkCheckResultに保存
  2. リトライ設定がある場合、リトライを実行
  3. リトライ後も失敗した場合、エラー結果として保存
  4. 処理を継続（他のURLの調査は続行）
- **ユーザーへの通知**: 調査結果にエラーとして記録（モーダルダイアログは表示しない）
- **ログ出力**: `[ERROR] Network error: {errorMessage} - {url}`

### エラー3: データベースエラー

- **発生条件**: SQLiteへの接続エラー、クエリ実行エラー
- **エラーコード**: `DATABASE_001`, `DATABASE_002`
- **処理内容**: 
  1. エラーログを記録
  2. 調査履歴のstatusを'error'に更新
  3. ユーザーにエラーメッセージを表示
  4. 調査を停止
- **ユーザーへの通知**: モーダルダイアログでエラーメッセージを表示
- **ログ出力**: `[ERROR] Database error: {errorMessage}`

### エラー4: ファイル操作エラー

- **発生条件**: ファイル保存エラー、ファイル読み込みエラー
- **エラーコード**: `FILE_001`
- **処理内容**: 
  1. エラーログを記録
  2. ユーザーにエラーメッセージを表示
- **ユーザーへの通知**: モーダルダイアログでエラーメッセージを表示
- **ログ出力**: `[ERROR] File error: {errorMessage} - {filePath}`

### エラー5: システムエラー

- **発生条件**: 予期しないエラー、未処理の例外
- **エラーコード**: `SYSTEM_001`
- **処理内容**: 
  1. エラーログを記録（スタックトレースを含む）
  2. ユーザーにエラーメッセージを表示
  3. アプリケーションを終了しない（可能な限り継続）
- **ユーザーへの通知**: モーダルダイアログでエラーメッセージを表示
- **ログ出力**: `[ERROR] System error: {errorMessage}\n{stackTrace}`

## 8.3 ログ詳細設計

### ログレベル

- **ERROR**: エラー（処理が失敗した場合）
- **WARN**: 警告（処理は成功したが、注意が必要な場合）
- **INFO**: 情報（通常の処理ログ）
- **DEBUG**: デバッグ（開発時の詳細ログ）

### ログ出力項目

- **タイムスタンプ**: ログ出力日時（ISO8601形式）
- **ログレベル**: ERROR, WARN, INFO, DEBUG
- **メッセージ**: ログメッセージ
- **コンテキスト**: 関連情報（URL、エラーコードなど）
- **スタックトレース**: エラー時のみ

### ログフォーマット

```
[YYYY-MM-DD HH:mm:ss.SSS] [LEVEL] Message - Context
```

例：
```
[2024-01-01 12:00:00.123] [ERROR] Network error: Connection timeout - URL: https://example.com
[2024-01-01 12:00:01.456] [INFO] Scan started - ScanHistoryId: 1, URL: https://example.com
[2024-01-01 12:00:02.789] [DEBUG] Link extracted - URL: https://example.com/page1, Source: https://example.com
```

### ログ保存期間

- **ログファイル**: 最大10MB、10ファイルまでローテーション
- **保存期間**: 30日間（古いログファイルは自動削除）
- **保存場所**: `{アプリケーションディレクトリ}/logs/`

### ログファイル命名規則

- **形式**: `app-{YYYY-MM-DD}.log`
- **例**: `app-2024-01-01.log`
- **ローテーション**: 日次でローテーション

## 8.4 エラーハンドリングの実装方針

### エラーの分類

1. **致命的エラー**: アプリケーションを継続できないエラー
   - データベース接続エラー
   - システムエラー
   - 対処: エラーメッセージを表示し、処理を停止

2. **非致命的エラー**: 処理を継続できるエラー
   - ネットワークエラー（個別のURL）
   - HTTPエラー（404、500など）
   - 対処: エラー情報を記録し、処理を継続

3. **バリデーションエラー**: 入力値の検証エラー
   - URL形式エラー
   - 設定値の範囲外エラー
   - 対処: エラーメッセージを表示し、入力を修正

### エラーハンドリングの原則

1. **エラーは即座に処理**: エラーが発生したら即座に処理する
2. **ユーザーに分かりやすいメッセージ**: 技術的詳細は含めず、分かりやすいメッセージを表示
3. **ログに詳細を記録**: エラーの詳細はログに記録
4. **処理を継続可能にする**: 可能な限り処理を継続し、アプリケーションを終了しない
5. **エラー情報を保存**: 調査結果としてエラー情報を保存

