# 基本設計書

## 1. システム構成

### 1.1 システム全体構成
```
┌─────────────────────────────────────────┐
│         Electron アプリケーション        │
├─────────────────────────────────────────┤
│  レンダラープロセス（React + TypeScript UI）│
│  ┌──────────────────────────────────┐  │
│  │  View（React + TypeScript Components）│  │
│  │  - メイン画面                     │  │
│  │  - 調査結果一覧画面               │  │
│  │  - 調査結果詳細画面               │  │
│  │  - 設定画面                       │  │
│  │  - 調査履歴画面                   │  │
│  └──────────────────────────────────┘  │
│           ↕ IPC                         │
│  ┌──────────────────────────────────┐  │
│  │  メインプロセス（Node.js）        │  │
│  │  ┌────────────────────────────┐  │  │
│  │  │ Controller（ビジネスロジック）│  │
│  │  │ - リンク切れ調査制御        │  │
│  │  │ - 並列処理管理              │  │
│  │  │ - データ管理                │  │
│  │  └────────────────────────────┘  │  │
│  │  ┌────────────────────────────┐  │  │
│  │  │ Model（データアクセス）     │  │
│  │  │ - ORM（Sequelize/TypeORM）  │  │
│  │  │ - SQLite アクセス           │  │
│  │  └────────────────────────────┘  │  │
│  │  ┌────────────────────────────┐  │
│  │  │ HTTP Client（axios）        │  │
│  │  │ - 外部サイトへのリクエスト  │  │
│  │  └────────────────────────────┘  │
│  └──────────────────────────────────┘  │
│           ↕                             │
│  ┌──────────────────────────────────┐  │
│  │   SQLite データベース            │  │
│  │   - 調査結果テーブル             │  │
│  │   - 調査履歴テーブル             │  │
│  │   - 設定テーブル                 │  │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

### 1.2 システム構成要素
- **メインプロセス（Node.js）**: バックエンドロジック、データベースアクセス、HTTPリクエスト処理
- **レンダラープロセス（React）**: UI表示、ユーザーインタラクション
- **SQLiteデータベース**: ローカルファイルとしてデータを保存
- **HTTPクライアント（axios）**: 外部サイトへのリクエスト送信
- **IPC（Inter-Process Communication）**: メインプロセスとレンダラープロセス間の通信
- **状態管理（Jotai）**: アプリケーション状態の管理
- **ORM（Sequelize/TypeORM）**: データベースアクセスの抽象化

### 1.3 システム間連携
- 既存システムとの連携は不要（スタンドアロンアプリケーション）
- 外部サイトへのHTTP/HTTPSリクエストのみ

## 2. アーキテクチャ

### 2.1 アーキテクチャパターン
MVC（Model-View-Controller）

### 2.2 レイヤー構成
3層アーキテクチャを採用

#### プレゼンテーション層（レンダラープロセス）
- React + TypeScriptコンポーネント（View）
- ユーザーインターフェース
- ユーザー入力の受付
- IPC経由でメインプロセスと通信

#### ビジネスロジック層（メインプロセス）
- Controller（ビジネスロジック、TypeScript）
- リンク切れ調査の制御
- 並列処理の管理
- データの加工・検証

#### データアクセス層（メインプロセス）
- Model（データアクセス、TypeScript）
- ORMによるデータベースアクセス
- SQLiteへの読み書き
- HTTPクライアントによる外部リクエスト

### 2.3 技術スタック
- フロントエンド: Electron + React + TypeScript
- バックエンド: Node.js + TypeScript（Electron内）
- データベース: SQLite
- ORM: Sequelize または TypeORM
- HTTPリクエスト: axios
- 状態管理: Jotai
- 通信方式: IPC（Inter-Process Communication）+ 状態管理ライブラリ（Jotai）
- 言語: TypeScript（フロントエンド・バックエンド共通）

## 3. 主要機能の設計

### 3.1 機能一覧
1. URL入力機能
2. リンク切れ調査機能（並列処理）
3. 調査結果表示機能
4. レポートエクスポート機能
5. 調査設定機能
6. 調査履歴機能
7. 調査結果フィルタリング機能
8. 調査結果検索機能
9. 調査制御機能（一時停止・再開）
10. 進捗表示機能
11. 統計情報表示機能

### 3.2 機能設計

#### 3.2.1 リンク切れ調査機能
- **実装方式**: 並列処理（複数ページを同時に調査）
- **処理フロー**:
  1. 入力URLから開始
  2. ページを取得してHTMLを解析
  3. リンクを抽出
  4. リンクをキューに追加
  5. 並列で複数ページを同時に調査
  6. HTTPステータスコードを確認
  7. リンク切れを判定
  8. 結果をデータベースに保存
- **並列処理**: 設定可能な並列リクエスト数で同時に複数ページを調査

#### 3.2.2 調査結果表示機能
- 調査結果一覧画面でリンク切れ情報を表示
- 調査結果詳細画面で詳細情報を表示
- フィルタリング・検索機能で結果を絞り込み

#### 3.2.3 調査制御機能
- 調査の一時停止・再開機能
- 進捗状況のリアルタイム表示

### 3.3 機能間の連携
- メイン画面 → 調査開始 → 調査結果一覧画面
- 調査結果一覧画面 → 詳細表示 → 調査結果詳細画面
- 設定画面 → 設定保存 → メイン画面で反映
- 調査履歴画面 → 履歴選択 → 調査結果一覧画面

## 4. データベース設計（概要）

### 4.1 データベース選定
- **データベース**: SQLite
- **選定理由**: 
  - 軽量でファイルベース
  - デスクトップアプリケーションに適している
  - 外部サーバー不要
  - ローカル実行に最適

### 4.2 主要テーブル構成

#### 調査結果テーブル（link_check_results）
- リンク切れ情報を保存
- 主なカラム: URL、リンク元URL、HTTPステータスコード、エラーメッセージ、調査日時など

#### 調査履歴テーブル（scan_history）
- 調査実行履歴を保存
- 主なカラム: 調査URL、調査日時、調査設定、調査結果数など

#### 設定テーブル（settings）
- アプリケーション設定を保存
- 主なカラム: 設定キー、設定値など

### 4.3 データリレーション
- 調査履歴テーブルと調査結果テーブルは1対多の関係
- 1つの調査履歴に対して複数の調査結果が紐づく

### 4.4 データフロー
1. ユーザーがURLを入力
2. 調査を開始
3. 調査結果をリアルタイムでデータベースに保存
4. 調査履歴をデータベースに保存
5. UIでデータベースから結果を取得して表示

## 5. API設計（概要）

### 5.1 API設計方針
- Electronアプリケーションのため、IPC（Inter-Process Communication）を使用
- レンダラープロセス（React）とメインプロセス（Node.js）間の通信
- 非同期処理を基本とする

### 5.2 API一覧（IPC通信）
- `startScan`: 調査を開始
- `stopScan`: 調査を停止
- `pauseScan`: 調査を一時停止
- `resumeScan`: 調査を再開
- `getScanResults`: 調査結果を取得
- `getScanHistory`: 調査履歴を取得
- `exportResults`: 調査結果をエクスポート
- `getSettings`: 設定を取得
- `saveSettings`: 設定を保存
- `filterResults`: 調査結果をフィルタリング
- `searchResults`: 調査結果を検索

### 5.3 API仕様概要
- すべてのAPIは非同期処理
- エラーハンドリングを実装
- 進捗状況をリアルタイムで通知

### 5.4 認証・認可方式
- 認証・認可は不要（ローカル実行のみ）

## 6. 画面遷移図

### 6.1 画面一覧
1. メイン画面（URL入力、調査開始）
2. 調査結果一覧画面
3. 調査結果詳細画面
4. 設定画面（調査オプション設定）
5. 調査履歴画面

### 6.2 画面遷移図
```
メイン画面
  ├─→ 調査開始 → 調査結果一覧画面
  │                    ├─→ 調査結果詳細画面
  │                    └─→ メイン画面（戻る）
  ├─→ 設定画面
  │     └─→ メイン画面（戻る）
  └─→ 調査履歴画面
        ├─→ 調査結果一覧画面（履歴選択）
        └─→ メイン画面（戻る）
```

### 6.3 主要画面の概要

#### メイン画面
- URL入力フィールド
- 調査開始ボタン
- 設定画面へのリンク
- 調査履歴画面へのリンク
- 進捗表示（調査中の場合）

#### 調査結果一覧画面
- リンク切れの一覧表示
- フィルタリング機能
- 検索機能
- エクスポートボタン
- 統計情報表示
- 詳細表示ボタン

#### 調査結果詳細画面
- リンク切れの詳細情報表示
- リンク元URL
- HTTPステータスコード
- エラーメッセージ
- 調査日時

#### 設定画面
- 調査オプションの設定
- 最大ページ数
- タイムアウト時間
- 並列リクエスト数
- その他の設定項目

#### 調査履歴画面
- 過去の調査履歴一覧
- 調査日時
- 調査URL
- 調査結果数
- 履歴選択で結果を表示

## 7. セキュリティ設計

### 7.1 認証・認可設計
- 認証・認可機能は不要（ローカル実行のみ）
- ユーザー認証は実装しない

### 7.2 データ保護設計
- ローカルに保存されるデータの暗号化は不要（初期リリース）
- 個人情報を扱わないため、特別な保護は不要
- SQLiteファイルはローカルに保存

### 7.3 通信セキュリティ設計
- HTTP/HTTPSリクエストを送信するため、HTTPS対応サイトは適切に処理
- 通信の暗号化は標準的なHTTPSを使用
- SSL/TLS証明書の検証を実施

## 8. エラーハンドリング

### 8.1 エラー分類
以下のエラーを分類して処理：
- **ネットワークエラー**: タイムアウト、接続エラー、DNS解決失敗など
- **HTTPエラー**: 404、500などのHTTPステータスコード
- **データベースエラー**: SQLite接続エラー、クエリエラーなど
- **バリデーションエラー**: URL形式エラー、入力値エラーなど

### 8.2 エラー処理方針
- ユーザーに分かりやすいエラーメッセージを表示
- エラーの種類に応じて適切な処理を実施
- ネットワークエラーやHTTPエラーは調査結果として記録
- 致命的なエラーはアプリケーションを終了せず、エラーメッセージを表示

### 8.3 ログ設計
- **エラーログ**: エラー発生時の記録
- **ログ保存**: ファイルに保存（ログファイル）
- **ログレベル**: ERROR、WARN、INFO、DEBUG
- **ログ内容**: エラー発生日時、エラーメッセージ、スタックトレースなど

## 9. パフォーマンス設計

### 9.1 パフォーマンス目標
- 1ページあたりの調査時間: 5秒以内
- レスポンスタイム: ユーザー操作に対する応答は即座に（1秒以内）
- UIの応答性: スムーズな操作感

### 9.2 パフォーマンス対策
- **並列処理**: 複数ページを同時に調査（設定可能な並列リクエスト数）
- **キャッシュ**: 調査済みURLのキャッシュ（重複調査を回避）
- **データベースインデックス**: 検索速度向上のためのインデックス設定
- **ページネーション**: 大量データの分割表示（調査結果一覧画面）

### 9.3 キャッシュ設計
- 調査済みURLをキャッシュして、同じURLの再調査を回避
- キャッシュの有効期限は設定可能
- メモリ上にキャッシュを保持

## 10. 運用設計（概要）

### 10.1 デプロイ設計
- **デプロイ方式**: Electron Builderを使用
- **パッケージング**: Windows用インストーラー（.exe）を作成
- **配布方法**: インストーラーファイルを配布
- **自動更新**: 初期リリースでは実装しない（将来検討）

### 10.2 監視設計
- ローカル実行のため、外部監視は不要
- アプリケーション内でエラーログを記録
- ユーザーがログファイルを確認可能

### 10.3 バックアップ設計
- SQLiteデータベースファイルをユーザーが手動でバックアップ可能
- 自動バックアップ機能は初期リリースでは不要
- データベースファイルの場所を明確に提示

